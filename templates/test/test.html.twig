{% extends 'base.html.twig' %}

{% block title %}
	Calendar_test
{% endblock %}

{% block header %}{% endblock %}
{% block sidebar %}{% endblock %}
{% block footer %}{% endblock %}

{% block body %}


	<div
		class="tab-pane active" id="users">
		{#---------------------------------------------Modal-------------------------------------------- #}
		{% embed "components/modal.html.twig" %}
			{% set modalType = "modal-lg" %}
			{% set id = "calendarForm" %}
			{% set buttonTitle = "Ajouter un utilisateur" %}
			{% block modalTitle %}Ajouter un evènement
			{% endblock %}
			{% block dashboard %}
				{% include "calendar/new.html.twig" %}
			{% endblock %}
		{% endembed %}
		{#--------------------------------------------Fin modal------------------------------------------- #}


	
	</div>

	{# --------------------------------------------------Calendar------------------------------------------ #}
	<div class="card-body">
		<div id='calendar2'></div>
	</div>
	{#-------------------------------------------------Fin Calendar-----------------------------------------#}

	{#----------------------------------------------- .Launch Modal info Button--------------------------------------#}

<!-- .modal -->
<div class="modal fade" id="Mysmallmodal">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">
                	Information
                </h4>                                                             
			</div> 
			<div class="modal-body">
				{% for calendar in calendar %}
				{{calendar.title}} {{calendar.teacherName}}
				{% endfor %}
			</div>   
		</div>                                                                       
	</div>                                      
</div>


{#-----------------------------------------------Fin Modal info Button------------------------------------------#}



	{# ---------------------------------------------------DELETE-------------------------------------------- #}
	{# {% for calendar in calendar %}
	<form method="post" action="{{ path('calendar_delete', {'id': calendar.id}) }}" onsubmit="return confirm('Are you sure you want to delete this item?');" style="position:fixed; top:30%; left:50%; background-color:lightGray; z-index:1000; color:black; display:none" id="delete" >
    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ calendar.id) }}">
    <button class="btn btn-danger">Delete</button>
	</form>
	{% endfor %} #}
	{# -------------------------------------------------FIN DELETE-------------------------------------------#}

	{# <div id='popup' style='position:fixed; top:30%; left:50%; background-color:lightGray; z-index:1000; color:black; display: none; '>
	    <form name="teacherName" method='POST' action='' >
	    <label for="Teacher">Choose a Teacher:</label>
	       <select id="monTeacher">
	            {% for calendar in calendrier %}
	            <option>{{calendar.teacherName}}</option>
	            {% endfor %}
	       </select>
	        <button type='submit' name='valider' value='valider'>Valider</button>
	    </form>
	</div> #}


	<script>

		window.onload = () => {


	var calendarEl = document.getElementById('calendar2');

	let urlVerif = document.location.href;

	localStorage['url'] = urlVerif;

	let urlInit = localStorage['url'];

	/*function calendrierShow(){
				$('#calendarFomr').modal('show')
			};*/

		function changeUrl(href){

			href = (href == "") ? "/" : href;
			window.location.href = href;
		}

	var calendar = new FullCalendar.Calendar(calendarEl, {
	headerToolbar: {
	left: 'prev,next today',
	center: 'title',
	right: 'dayGridMonth,timeGridWeek,timeGridDay'
	},

	defaultView: 'month',
	navLinks: true, // can click day/week names to navigate views
	businessHours: true, // display business hours
	editable: true,
	selectable: true,
	selectMirror: true,
	droppable: true, // this allows things to be dropped onto the calendar
	select: function (arg) {



		localStorage["start"] = arg.start;
		localStorage["end"] = arg.end;

		function start(){

			let maClosure = () => {
			
				let start = arg.start;
			}

			return maClosure;
		}

		let startmod = start();

		function end(){

			let maClosure = () => {
			
				let end = arg.end;
			}

			return maClosure;
		}

		let endmod = start();




		let urlVerif = document.location.href;
		let urlcompte = urlVerif.length;
		var start = JSON.stringify(arg.start);
		var end = JSON.stringify(arg.end);
		var dtExpire = new Date();
   		dtExpire.setTime(dtExpire.getTime() + 3600 * 1000);
		document.cookie = "start= "+arg.start+"; expires=" + new Date(dtExpire).toUTCString() + "; path=/";
		document.cookie = "end= "+arg.end+"; expires=" + new Date(dtExpire).toUTCString() + "; path=/";

		
		function getCookie(name){
			if(document.cookie.length == 0)
			return null;

			var regSepCookie = new RegExp('(; )', 'g');
			var cookies = document.cookie.split(regSepCookie);

			for(var i = 0; i < cookies.length; i++){
			var regInfo = new RegExp('=', 'g');
			var infos = cookies[i].split(regInfo);
			if(infos[0] == name){
				return unescape(infos[1]);
			}
			}
        return null;
  	    }
		
		/*function setCookie(nom, valeur, expire, chemin, domaine, securite){
     		document.cookie = nom + ' = ' + escape(valeur) + '  ' +
               ((expire == undefined) ? '' : ('; expires = ' + expire.toGMTString())) +
               ((chemin == undefined) ? '' : ('; path = ' + chemin)) +
               ((domaine == undefined) ? '' : ('; domain = ' + domaine)) +
               ((securite == true) ? '; secure' : '');
   			}

			var dtExpire = new Date();
			dtExpire.setTime(dtExpire.getTime() + 3600 * 1000);


				setCookie('start', arg.start, dtExpire);
				

				function getCookie(name){
				if(document.cookie.length == 0)
				return null;

			var regSepCookie = new RegExp('(; )', 'g');
			var cookies = document.cookie.split(regSepCookie);

				for(var i = 0; i < cookies.length; i++){
			var regInfo = new RegExp('=', 'g');
			var infos = cookies[i].split(regInfo);
			if(infos[0] == name){
			return unescape(infos[1]);
			}
       	}
       return null;
      }*/


		

		function calendrierShow(){
				$('#calendarForm').modal('show');
			}


		/* function changeUrl(href){
			$('#calendarForm').load(href);
			href = (href == "") ? "/" : href;
			uri = window.location.href;
			window.location.href = uri[0] + "/" + href;
		} */

		
	
	
	function initialisation(){

		let maClosure = () => {
		
		//?donnees={"start":"2022-04-10T22:00:00.000Z",end:"2022-04-15T22:00:00.000Z"}
		let urlmodif = window.history.pushState('api', 'New Page Title', '/api?donnees={"start"'+':'+ start+','+'"end"'+':'+ end+'}');


		let urlVerifmodif = document.location.href;

		

		if(urlVerif != urlVerifmodif){


			
			//changeUrl(url);
			//setTimeout(location.reload(), 5000);

			if (confirm('Vous souhaitez entrer un nouvel évènement ?')) {


					calendrierShow();


				}
			


			}else{

					//setTimeout(calendrierShow, 2000);

			}


		}

    	return maClosure;
	}

	//calendrierShow();


	let debut = initialisation()


	debut();


	
	
	

	$(document).ready(function(){

		let donnee = {
				'start' : arg.start,
				'end' : arg.end,
			}
			$.ajax({
        type: 'GET',
        url: '/api',
        data: {donnees: JSON.stringify(donnee)},
        dataType: 'donnees'            
    })
	//%7B"start"%3A"2022-05-09T22%3A00%3A00.000Z"%2C"end"%3A"2022-05-12T22%3A00%3A00.000Z"%7D
	


	//$('body').load(url);

		$("#envoyerFormulaire").click(function(){

			var title = $("#title").val();
			var description = $("#description").val();
			var teacherName = $("#teacher").val();

			
			calendar.addEvent({

						title: title,
						start: arg.start,
						end: arg.end,
						allDay: arg.allDay,
						teacherName: teacherName,
						description: description

				})


			
			calendar.unselect();

			
		})

		
})


		
},



				eventClick: function (arg) {
				if (confirm('Are you sure you want to delete this event?')) {


					arg.event.remove()
				}

				
				},
				eventOverlap: function(stillEvent, movingEvent) {
    			return stillEvent.allDay && movingEvent.allDay;
  				},

				/*eventMouseEnter:function( mouseEnterInfo ) {

					$('#Mysmallmodal').modal('show');
				 },*/
				editable: true,
				dayMaxEvents: true, // allow "more" link when too many events
				events: [{% for calendar in calendar %}{
				id: '{{calendar.id}}',
				title:'{{ calendar.title }}',
				start: '{{ calendar.start |date('Y-m-d H:i:s') }}',
				end: '{{ calendar.end |date('Y-m-d H:i:s') }}',
				description: '{{ calendar.description }}',
				backgroundColor: '{{ calendar.backgroundColor }}'

				},{% endfor %}]

			
				})

					$.ajax(this.href, {
                       
                        success: function() {

							if(urlVerif.length > 50){
								
                           		$('#calendarForm').modal('show');
						   

								let url = document.location.href;
          
        						let urlStart = substr(url,10,24);
        						let urlEnd = substr(url,43,-2);

								console.log(urlStart);
								console.log(urlEnd);


						   		$("#envoyerFormulaire").click(function(){

									var title = $("#title").val();
									var description = $("#description").val();
									var teacherName = $("#teacher").val();

			
									calendar.addEvent({

										title: title,
										start: getCookie('start'),
										end: getCookie('end'),
										allDay: arg.allDay,
										teacherName: teacherName,
										description: description,

									})

									calendar.unselect();


						   		})

						   	}

							
                        }


						
                    });

				//$('#calendarFomr').modal('show');

				calendar.on('eventAdd', (e) => {
				let url = '/api/edit'
				let donnees = {
				"title": e.event.title,
				"start": e.event.start,
				"end": e.event.end,
				"description": e.event.extendedProps.description,
				"teacherName": e.event.extendedProps.teacherName,
				"teacherId": " ",
				"backgroundColor": '#0080ff'


				}


				let xhr = new XMLHttpRequest

				xhr.open("PUT", url, true)
				xhr.send(JSON.stringify(donnees))


				})

				
				

				calendar.render();

				calendar.on('eventChange', (e) => {
				let url = `/api/${e.event.id}/edit`
				let donnees = {
				"title": e.event.title,
				"start": e.event.start,
				"end": e.event.end,
				"description": e.event.extendedProps.description,
				"backgroundColor": e.event.backgroundColor


				}


				let xhr = new XMLHttpRequest

				xhr.open("PUT", url, true)
				xhr.send(JSON.stringify(donnees))



				})



				calendar.on('eventRemove', (e) => {
				let url = `/api/${e.event.id}/delete`
				let donnees = {
				"id": e.event.id
				}


				let xhr = new XMLHttpRequest

				xhr.open("PUT", url, true)
				xhr.send(JSON.stringify(donnees))


				});

		/*calendar.select( start, (e) => {
		let donnees = {
			"start": e.event.start,
			"end" : e.event.end
		}
		
			$.ajax({
        type: 'POST',
        url: '/test2',
        data: {json: JSON.stringify(donnees)},
        dataType: 'json'            
    })

	});*/

	//setTimeout(changeUrl(urlInit),10000);
	

}
	</script>
{% endblock %}
